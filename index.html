<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grasshopper</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    #root {
      width: 100vw;
      height: 100vh;
    }

    .app {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      transition: background 0.3s;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-size: 1.5rem;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      gap: 1rem;
      flex-shrink: 0;
    }

    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .board-select {
      padding: 0.5rem;
      border: 1px solid;
      border-radius: 4px;
      font-size: 1rem;
      min-width: 200px;
    }

    .add-board-form {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .add-board-form input {
      padding: 0.5rem;
      border: 1px solid;
      border-radius: 4px;
      font-size: 1rem;
      min-width: 200px;
    }

    .btn-primary, .btn-secondary, .btn-danger, .btn-icon, .btn-add-card, .btn-add-list {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-primary:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #f1f5f9;
      color: #1e293b;
    }

    .btn-secondary:hover {
      background: #e2e8f0;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-icon {
      padding: 0.25rem;
      background: transparent;
    }

    .btn-icon:hover {
      background: rgba(0, 0, 0, 0.1);
    }

    .settings-panel, .templates-panel {
      padding: 2rem;
      max-height: 500px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .settings-section {
      margin: 1.5rem 0;
    }

    .settings-section label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .settings-section input, .settings-section textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid;
      border-radius: 4px;
      font-size: 1rem;
    }

    .backgrounds-grid, .color-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .bg-btn, .color-btn {
      height: 60px;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .bg-btn:hover, .color-btn:hover {
      transform: scale(1.05);
    }

    .bg-btn.active, .color-btn.active {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }

    .theme-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .theme-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-btn.active {
      border-color: #3b82f6;
      background: #dbeafe;
    }

    .users-list, .labels-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .user-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .templates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .template-card {
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .template-card h4 {
      margin-bottom: 0.5rem;
    }

    .template-card p {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .template-actions {
      display: flex;
      gap: 0.5rem;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
      padding: 2rem;
    }

    .empty-state h2 {
      margin-bottom: 1rem;
    }

    .board {
      flex: 1;
      padding: 2rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .lists-container {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 1rem;
      flex: 1;
    }

    .list {
      min-width: 300px;
      max-width: 300px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-shrink: 0;
    }

    .list-title {
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      flex: 1;
    }

    .list-title:hover {
      color: #3b82f6;
    }

    .card-count {
      font-size: 0.85rem;
      opacity: 0.6;
      font-weight: normal;
    }

    .list-title-input {
      width: 100%;
      padding: 0.25rem;
      border: 2px solid #3b82f6;
      border-radius: 4px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .cards {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
      min-height: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .card {
      padding: 0.75rem;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      cursor: grab;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .card:hover {
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .card:active {
      cursor: grabbing;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      flex: 1;
      line-height: 1.4;
    }

    .card-title:hover {
      color: #3b82f6;
    }

    .card-title-input {
      width: 100%;
      padding: 0.25rem;
      border: 2px solid #3b82f6;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 500;
    }

    .card-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: #f1f5f9;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #64748b;
    }

    .card-labels, .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .label {
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: 500;
      line-height: 1.2;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: #e0f2fe;
      color: #0369a1;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .card-details {
      margin-top: 1rem;
    }

    .card-section {
      margin: 1rem 0;
    }

    .card-section label {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: #475569;
    }

    .card-section input, .card-section textarea, .card-section select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .card-section textarea {
      resize: vertical;
      min-height: 60px;
    }

    .card-description {
      padding: 0.5rem;
      min-height: 120px;
      background: #f8fafc;
      border-radius: 4px;
      cursor: pointer;
      color: #64748b;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .card-description.has-content {
      color: #1e293b;
    }

    .card-description strong {
      font-weight: 700;
    }

    .card-description em {
      font-style: italic;
    }

    .card-description u {
      text-decoration: underline;
    }

    .card-description ul {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .card-description li {
      margin-bottom: 0.25rem;
    }

    .format-toolbar {
      display: flex;
      gap: 0.25rem;
      padding: 0.5rem;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      flex-wrap: wrap;
    }

    .format-btn {
      padding: 0.4rem;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .format-btn:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .format-btn.active {
      background: #dbeafe;
      border-color: #3b82f6;
      color: #3b82f6;
    }

    .format-textarea {
      border-radius: 0 0 4px 4px !important;
      border-top: none !important;
    }

    .card-description:hover {
      background: #f1f5f9;
    }

    .assignees-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .assignee {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .add-assignee {
      display: flex;
      gap: 0.5rem;
    }

    .assignee-select, .assignee-input {
      flex: 1;
    }

    .labels-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
    }

    .label-btn {
      padding: 0.4rem;
      border: 2px solid transparent;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .label-btn:hover {
      opacity: 0.8;
    }

    .label-btn.active {
      border-color: #1e293b;
    }

    .checklist {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .checklist-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checklist-item input[type="checkbox"] {
      width: auto;
    }

    .checklist-item input[type="text"] {
      flex: 1;
    }

    .custom-field {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr auto;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .field-name {
      font-weight: 600;
    }

    .field-type {
      font-size: 0.85rem;
    }

    .comments {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .comment {
      padding: 0.5rem;
      background: #f8fafc;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .comment strong {
      color: #3b82f6;
      margin-right: 0.5rem;
    }

    .comment-time {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .comment p {
      margin-top: 0.25rem;
    }

    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #e2e8f0;
    }

    .add-card-form, .add-list-form {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .add-card-form input, .add-list-form input {
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 1rem;
    }

    .form-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn-add-card, .btn-add-list {
      width: 100%;
      justify-content: center;
      background: rgba(0, 0, 0, 0.05);
      color: #64748b;
      flex-shrink: 0;
    }

    .btn-add-card:hover, .btn-add-list:hover {
      background: rgba(0, 0, 0, 0.1);
    }

    .btn-add-list {
      min-width: 300px;
      padding: 1rem;
      font-size: 1rem;
    }

    .archived-section {
      margin-top: 2rem;
      padding: 1.5rem;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .archived-section h3 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .archived-cards {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .archived-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
    }

    .archived-card small {
      opacity: 0.6;
      margin-left: 0.5rem;
    }

    .archived-card > div {
      display: flex;
      gap: 0.5rem;
    }

    svg {
      flex-shrink: 0;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 2rem;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .modal-header {
      padding: 2rem 2rem 1rem 2rem;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }

    .modal-header.has-cover {
      padding-top: 0;
      border-bottom: none;
    }

    .card-cover {
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
    }

    .cover-overlay {
      position: relative;
    }

    .cover-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.5rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .cover-overlay:hover .cover-actions {
      opacity: 1;
    }

    .cover-btn {
      padding: 0.5rem;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.85rem;
      transition: background 0.2s;
    }

    .cover-btn:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      padding-right: 2rem;
    }

    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem;
      border: none;
      background: transparent;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .modal-close:hover {
      background: #f1f5f9;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-section {
      margin-bottom: 2rem;
    }

    .modal-section-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #475569;
    }

    .modal-footer {
      padding: 1.5rem 2rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      position: sticky;
      bottom: 0;
      background: white;
    }

    .attachments-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .attachment-item:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .attachment-icon {
      flex-shrink: 0;
      color: #64748b;
    }

    .attachment-info {
      flex: 1;
      min-width: 0;
    }

    .attachment-name {
      font-weight: 500;
      font-size: 0.9rem;
      color: #1e293b;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .attachment-meta {
      font-size: 0.75rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .attachment-actions {
      display: flex;
      gap: 0.5rem;
    }

    .file-input-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #f1f5f9;
      color: #1e293b;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
      border: none;
    }

    .file-input-label:hover {
      background: #e2e8f0;
    }

    .file-input-hidden {
      display: none;
    }

    .calendar-view {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .calendar-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .calendar-nav {
      display: flex;
      gap: 0.5rem;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      font-size: 0.85rem;
      padding: 0.5rem;
      color: #64748b;
    }

    .calendar-day {
      min-height: 100px;
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      background: white;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-day:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
    }

    .calendar-day.other-month {
      background: #f8fafc;
      color: #94a3b8;
    }

    .calendar-day.today {
      border-color: #3b82f6;
      border-width: 2px;
      background: #eff6ff;
    }

    .calendar-day-number {
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .calendar-events {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .calendar-event {
      font-size: 0.75rem;
      padding: 0.25rem 0.35rem;
      border-radius: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .calendar-event.card-due {
      background: #fee2e2;
      color: #991b1b;
    }

    .calendar-event.appointment {
      background: #dbeafe;
      color: #1e40af;
    }

    .calendar-sidebar {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .event-form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .event-form input,
    .event-form textarea,
    .event-form select {
      padding: 0.5rem;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .event-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .event-item {
      padding: 0.75rem;
      background: #f8fafc;
      border-radius: 4px;
      border-left: 3px solid #3b82f6;
    }

    .event-item-title {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .event-item-meta {
      font-size: 0.75rem;
      color: #64748b;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Simple localStorage-based storage for standalone version
    const storage = {
      get(key) {
        try {
          const item = localStorage.getItem(`trello_${key}`);
          return item ? JSON.parse(item) : null;
        } catch (error) {
          console.error('Storage get error:', error);
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(`trello_${key}`, JSON.stringify(value));
        } catch (error) {
          console.error('Storage set error:', error);
        }
      }
    };

    // SVG Icons as components
    const Plus = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const X = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const Trash2 = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      </svg>
    );

    const Archive = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="21 8 21 21 3 21 3 8"></polyline>
        <rect x="1" y="3" width="22" height="5"></rect>
        <line x1="10" y1="12" x2="14" y2="12"></line>
      </svg>
    );

    const Calendar = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const Tag = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
        <line x1="7" y1="7" x2="7.01" y2="7"></line>
      </svg>
    );

    const User = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
        <circle cx="12" cy="7" r="4"></circle>
      </svg>
    );

    const CheckSquare = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 11 12 14 22 4"></polyline>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
      </svg>
    );

    const MessageSquare = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    );

    const Copy = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
      </svg>
    );

    const Settings = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m8.66-10a10 10 0 0 1-2.83 6.83m-11.66 0A10 10 0 0 1 3.34 10M21 12h-6m-6 0H3"></path>
      </svg>
    );

    const Palette = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="13.5" cy="6.5" r=".5"></circle>
        <circle cx="17.5" cy="10.5" r=".5"></circle>
        <circle cx="8.5" cy="7.5" r=".5"></circle>
        <circle cx="6.5" cy="12.5" r=".5"></circle>
        <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path>
      </svg>
    );

    const ChevronDown = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );

    const Clock = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    );

    const Moon = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    );

    const Sun = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    );

    const Bold = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
        <path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path>
      </svg>
    );

    const Italic = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="19" y1="4" x2="10" y2="4"></line>
        <line x1="14" y1="20" x2="5" y2="20"></line>
        <line x1="15" y1="4" x2="9" y2="20"></line>
      </svg>
    );

    const Underline = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path>
        <line x1="4" y1="21" x2="20" y2="21"></line>
      </svg>
    );

    const ListIcon = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="8" y1="6" x2="21" y2="6"></line>
        <line x1="8" y1="12" x2="21" y2="12"></line>
        <line x1="8" y1="18" x2="21" y2="18"></line>
        <line x1="3" y1="6" x2="3.01" y2="6"></line>
        <line x1="3" y1="12" x2="3.01" y2="12"></line>
        <line x1="3" y1="18" x2="3.01" y2="18"></line>
      </svg>
    );

    const Paperclip = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
      </svg>
    );

    const Download = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Edit2 = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
      </svg>
    );

    const ChevronLeft = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    );

    const ChevronRight = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const Image = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21 15 16 10 5 21"></polyline>
      </svg>
    );

    // Color palettes
    const LABEL_COLORS = [
      { name: 'Priority 1 - Critical', color: '#991b1b', bg: '#fee2e2' },
      { name: 'Priority 2 - High', color: '#dc2626', bg: '#fecaca' },
      { name: 'Priority 1 - Medium', color: '#a16207', bg: '#fef9c3' },
      { name: 'Priority 2 - Normal', color: '#ca8a04', bg: '#fef08a' },
      { name: 'Priority 1 - Low', color: '#15803d', bg: '#dcfce7' },
      { name: 'Priority 2 - Minor', color: '#16a34a', bg: '#bbf7d0' }
    ];

    const BOARD_BACKGROUNDS = [
      { name: 'Ocean', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
      { name: 'Sunset', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
      { name: 'Forest', color: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
      { name: 'Desert', color: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
      { name: 'Night', color: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)' },
      { name: 'Aurora', color: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' },
      { name: 'Fire', color: 'linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%)' },
      { name: 'Sky', color: 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)' }
    ];

    const THEMES = {
      light: { name: 'Light', bg: '#f8fafc', text: '#1e293b', cardBg: '#ffffff', border: '#e2e8f0' },
      dark: { name: 'Dark', bg: '#0f172a', text: '#f1f5f9', cardBg: '#1e293b', border: '#334155' },
      warm: { name: 'Warm', bg: '#fef3c7', text: '#78350f', cardBg: '#fffbeb', border: '#fde68a' }
    };

    // Card component
    const Card = ({ card, onUpdate, onDelete, onArchive, boardLabels, boardUsers, onSaveAsTemplate, onOpenModal }) => {
      const cardColor = card.color || '#ffffff';
      const hasDetails = card.description || card.dueDate || (card.labels && card.labels.length > 0) || 
                         (card.tags && card.tags.length > 0) || (card.assignees && card.assignees.length > 0) ||
                         (card.checklist && card.checklist.length > 0) || (card.comments && card.comments.length > 0) ||
                         (card.customFields && card.customFields.length > 0) || (card.attachments && card.attachments.length > 0);

      return (
        <div
          className="card"
          style={{ backgroundColor: cardColor }}
          draggable
          onDragStart={(e) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('cardId', card.id);
          }}
          onClick={() => onOpenModal(card)}
        >
          {card.coverImage && (
            <img 
              src={card.coverImage} 
              alt="Cover" 
              style={{ 
                width: '100%', 
                height: '120px', 
                objectFit: 'cover', 
                borderRadius: '6px 6px 0 0',
                marginBottom: '0.5rem',
                marginTop: '-0.75rem',
                marginLeft: '-0.75rem',
                marginRight: '-0.75rem',
                width: 'calc(100% + 1.5rem)'
              }} 
            />
          )}
          <div className="card-header">
            <h4 className="card-title">
              {card.title}
            </h4>
          </div>

          {hasDetails && (
            <div className="card-badges">
              {card.dueDate && (
                <span className="badge">
                  <Clock size={12} /> {new Date(card.dueDate).toLocaleDateString()}
                </span>
              )}
              {card.checklist && card.checklist.length > 0 && (
                <span className="badge">
                  <CheckSquare size={12} /> {card.checklist.filter(i => i.done).length}/{card.checklist.length}
                </span>
              )}
              {card.attachments && card.attachments.length > 0 && (
                <span className="badge">
                  <Paperclip size={12} /> {card.attachments.length}
                </span>
              )}
              {card.comments && card.comments.length > 0 && (
                <span className="badge">
                  <MessageSquare size={12} /> {card.comments.length}
                </span>
              )}
            </div>
          )}

          {card.labels && card.labels.length > 0 && (
            <div className="card-labels">
              {card.labels.map(labelId => {
                const label = boardLabels.find(l => l.id === labelId);
                return label ? (
                  <span key={labelId} className="label" style={{ backgroundColor: label.bg, color: label.color }}>
                    {label.name}
                  </span>
                ) : null;
              })}
            </div>
          )}

          {card.tags && card.tags.length > 0 && (
            <div className="card-tags">
              {card.tags.slice(0, 2).map(tag => (
                <span key={tag} className="tag">{tag}</span>
              ))}
              {card.tags.length > 2 && <span className="tag">+{card.tags.length - 2} more</span>}
            </div>
          )}
        </div>
      );
    };

    // Card Modal component
    const CardModal = ({ card, onClose, onUpdate, onDelete, onArchive, boardLabels, boardUsers, onSaveAsTemplate }) => {
      const [editingField, setEditingField] = useState(null);
      const [editValue, setEditValue] = useState('');
      const textareaRef = useRef(null);

      const startEdit = (field, value) => {
        setEditingField(field);
        setEditValue(value || '');
      };

      const saveEdit = () => {
        if (editingField) {
          onUpdate({ ...card, [editingField]: editValue });
          setEditingField(null);
        }
      };

      const applyFormat = (formatType) => {
        if (!textareaRef.current) return;
        
        const textarea = textareaRef.current;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = editValue.substring(start, end);
        
        let newText = editValue;
        let newCursorPos = end;

        if (selectedText) {
          // Apply formatting to selected text
          let formattedText = selectedText;
          switch (formatType) {
            case 'bold':
              formattedText = `**${selectedText}**`;
              newCursorPos = start + formattedText.length;
              break;
            case 'italic':
              formattedText = `*${selectedText}*`;
              newCursorPos = start + formattedText.length;
              break;
            case 'underline':
              formattedText = `__${selectedText}__`;
              newCursorPos = start + formattedText.length;
              break;
            case 'bullet':
              formattedText = selectedText.split('\n').map(line => line.trim() ? `• ${line}` : line).join('\n');
              newCursorPos = start + formattedText.length;
              break;
          }
          newText = editValue.substring(0, start) + formattedText + editValue.substring(end);
        } else {
          // Insert formatting markers at cursor
          switch (formatType) {
            case 'bold':
              newText = editValue.substring(0, start) + '****' + editValue.substring(end);
              newCursorPos = start + 2;
              break;
            case 'italic':
              newText = editValue.substring(0, start) + '**' + editValue.substring(end);
              newCursorPos = start + 1;
              break;
            case 'underline':
              newText = editValue.substring(0, start) + '____' + editValue.substring(end);
              newCursorPos = start + 2;
              break;
            case 'bullet':
              newText = editValue.substring(0, start) + '• ' + editValue.substring(end);
              newCursorPos = start + 2;
              break;
          }
        }

        setEditValue(newText);
        
        // Restore cursor position
        setTimeout(() => {
          textarea.focus();
          textarea.setSelectionRange(newCursorPos, newCursorPos);
        }, 0);
      };

      const renderFormattedDescription = (text) => {
        if (!text) return 'Click to add description...';
        
        // Simple markdown-style rendering - using simpler regex
        let formatted = text;
        
        // Bold: **text** (but not *** which would be italic inside bold)
        formatted = formatted.replace(/\*\*([^\*]+?)\*\*/g, '<strong>$1</strong>');
        
        // Italic: *text* (single asterisk, not double)
        formatted = formatted.replace(/\*([^\*]+?)\*/g, '<em>$1</em>');
        
        // Underline: __text__
        formatted = formatted.replace(/__([^_]+?)__/g, '<u>$1</u>');
        
        // Bullet points
        const lines = formatted.split('\n');
        let inList = false;
        let result = [];
        
        for (let line of lines) {
          if (line.trim().startsWith('•')) {
            if (!inList) {
              result.push('<ul>');
              inList = true;
            }
            result.push(`<li>${line.trim().substring(1).trim()}</li>`);
          } else {
            if (inList) {
              result.push('</ul>');
              inList = false;
            }
            result.push(line);
          }
        }
        
        if (inList) {
          result.push('</ul>');
        }
        
        formatted = result.join('\n');
        
        return <div dangerouslySetInnerHTML={{ __html: formatted }} />;
      };

      const addChecklistItem = () => {
        const checklist = [...(card.checklist || []), { id: Date.now(), text: '', done: false }];
        onUpdate({ ...card, checklist });
      };

      const updateChecklistItem = (id, updates) => {
        const checklist = card.checklist.map(item => item.id === id ? { ...item, ...updates } : item);
        onUpdate({ ...card, checklist });
      };

      const deleteChecklistItem = (id) => {
        const checklist = card.checklist.filter(item => item.id !== id);
        onUpdate({ ...card, checklist });
      };

      const addComment = (text) => {
        if (!text.trim()) return;
        const comments = [...(card.comments || []), { id: Date.now(), text, timestamp: new Date().toISOString(), author: 'You' }];
        onUpdate({ ...card, comments });
      };

      const addCustomField = () => {
        const customFields = [...(card.customFields || []), { id: Date.now(), name: 'New Field', type: 'text', value: '' }];
        onUpdate({ ...card, customFields });
      };

      const updateCustomField = (id, updates) => {
        const customFields = card.customFields.map(field => field.id === id ? { ...field, ...updates } : field);
        onUpdate({ ...card, customFields });
      };

      const deleteCustomField = (id) => {
        const customFields = card.customFields.filter(field => field.id !== id);
        onUpdate({ ...card, customFields });
      };

      const toggleLabel = (labelId) => {
        const labels = card.labels || [];
        const hasLabel = labels.includes(labelId);
        onUpdate({ ...card, labels: hasLabel ? labels.filter(l => l !== labelId) : [...labels, labelId] });
      };

      const addTag = (tag) => {
        if (!tag.trim()) return;
        const tags = [...(card.tags || []), tag.trim()];
        onUpdate({ ...card, tags });
      };

      const removeTag = (tag) => {
        const tags = card.tags.filter(t => t !== tag);
        onUpdate({ ...card, tags });
      };

      const addAssignee = (assignee) => {
        if (!assignee.trim()) return;
        const assignees = [...(card.assignees || []), assignee.trim()];
        onUpdate({ ...card, assignees });
      };

      const removeAssignee = (assignee) => {
        const assignees = card.assignees.filter(a => a !== assignee);
        onUpdate({ ...card, assignees });
      };

      const handleFileUpload = (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        const newAttachments = files.map(file => ({
          id: Date.now() + Math.random(),
          name: file.name,
          size: file.size,
          type: file.type,
          uploadedAt: new Date().toISOString(),
          data: null // In a real app, you'd upload to a server
        }));

        // Store file data as base64 for demo purposes (works for small files)
        files.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            newAttachments[index].data = event.target.result;
            if (index === files.length - 1) {
              const attachments = [...(card.attachments || []), ...newAttachments];
              onUpdate({ ...card, attachments });
            }
          };
          reader.readAsDataURL(file);
        });
      };

      const deleteAttachment = (attachmentId) => {
        if (confirm('Delete this attachment?')) {
          const attachments = card.attachments.filter(a => a.id !== attachmentId);
          onUpdate({ ...card, attachments });
        }
      };

      const downloadAttachment = (attachment) => {
        if (!attachment.data) return;
        const link = document.createElement('a');
        link.href = attachment.data;
        link.download = attachment.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const openAttachment = (attachment, e) => {
        // Don't trigger if clicking on action buttons
        if (e.target.closest('.attachment-actions')) return;
        
        if (!attachment.data) return;
        
        // For images and PDFs, open in new tab
        if (attachment.type.startsWith('image/') || attachment.type === 'application/pdf') {
          window.open(attachment.data, '_blank');
        } else {
          // For other file types, download
          downloadAttachment(attachment);
        }
      };

      const formatFileSize = (bytes) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      };

      const handleCoverUpload = (e) => {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }

        const reader = new FileReader();
        reader.onload = (event) => {
          onUpdate({ ...card, coverImage: event.target.result });
        };
        reader.readAsDataURL(file);
      };

      const removeCover = () => {
        if (confirm('Remove cover image?')) {
          onUpdate({ ...card, coverImage: null });
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            {/* Cover Image */}
            {card.coverImage && (
              <div className="cover-overlay">
                <img src={card.coverImage} alt="Cover" className="card-cover" />
                <div className="cover-actions">
                  <label className="cover-btn">
                    <Image size={14} /> Change
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleCoverUpload}
                      style={{ display: 'none' }}
                    />
                  </label>
                  <button onClick={removeCover} className="cover-btn">
                    <X size={14} /> Remove
                  </button>
                </div>
              </div>
            )}

            <div className={`modal-header ${card.coverImage ? 'has-cover' : ''}`}>
              {editingField === 'title' ? (
                <input
                  value={editValue}
                  onChange={(e) => setEditValue(e.target.value)}
                  onBlur={saveEdit}
                  onKeyPress={(e) => e.key === 'Enter' && saveEdit()}
                  autoFocus
                  className="card-title-input"
                  style={{ fontSize: '1.5rem', fontWeight: 600 }}
                />
              ) : (
                <h2 onClick={() => startEdit('title', card.title)} className="modal-title" style={{ cursor: 'pointer' }}>
                  {card.title}
                </h2>
              )}
              <button onClick={onClose} className="modal-close">
                <X size={24} />
              </button>
            </div>

            <div className="modal-body">
              {/* Labels */}
              {card.labels && card.labels.length > 0 && (
                <div className="card-labels" style={{ marginBottom: '1rem' }}>
                  {card.labels.map(labelId => {
                    const label = boardLabels.find(l => l.id === labelId);
                    return label ? (
                      <span key={labelId} className="label" style={{ backgroundColor: label.bg, color: label.color }}>
                        {label.name}
                      </span>
                    ) : null;
                  })}
                </div>
              )}

              {/* Description */}
              <div className="modal-section">
                <div className="modal-section-title">Description</div>
                {editingField === 'description' ? (
                  <div>
                    <div className="format-toolbar">
                      <button 
                        className="format-btn" 
                        onMouseDown={(e) => e.preventDefault()} 
                        onClick={() => applyFormat('bold')} 
                        title="Bold (**text**)"
                        type="button"
                      >
                        <Bold size={16} />
                      </button>
                      <button 
                        className="format-btn" 
                        onMouseDown={(e) => e.preventDefault()} 
                        onClick={() => applyFormat('italic')} 
                        title="Italic (*text*)"
                        type="button"
                      >
                        <Italic size={16} />
                      </button>
                      <button 
                        className="format-btn" 
                        onMouseDown={(e) => e.preventDefault()} 
                        onClick={() => applyFormat('underline')} 
                        title="Underline (__text__)"
                        type="button"
                      >
                        <Underline size={16} />
                      </button>
                      <button 
                        className="format-btn" 
                        onMouseDown={(e) => e.preventDefault()} 
                        onClick={() => applyFormat('bullet')} 
                        title="Bullet List (• )"
                        type="button"
                      >
                        <ListIcon size={16} />
                      </button>
                      <div style={{ marginLeft: 'auto', fontSize: '0.75rem', color: '#64748b', display: 'flex', alignItems: 'center' }}>
                        Click button or select text to format
                      </div>
                    </div>
                    <textarea
                      ref={textareaRef}
                      value={editValue}
                      onChange={(e) => setEditValue(e.target.value)}
                      rows={10}
                      className="format-textarea"
                      style={{ width: '100%', padding: '0.75rem', border: '1px solid #e2e8f0', fontSize: '0.95rem' }}
                    />
                    <div style={{ marginTop: '0.5rem', display: 'flex', gap: '0.5rem' }}>
                      <button onClick={saveEdit} className="btn-primary">Save</button>
                      <button onClick={() => setEditingField(null)} className="btn-secondary">Cancel</button>
                    </div>
                  </div>
                ) : (
                  <div 
                    onClick={() => startEdit('description', card.description)} 
                    className={`card-description ${card.description ? 'has-content' : ''}`} 
                    style={{ minHeight: '120px' }}
                  >
                    {renderFormattedDescription(card.description)}
                  </div>
                )}
              </div>

              {/* Due Date */}
              <div className="modal-section">
                <div className="modal-section-title"><Calendar size={16} /> Due Date</div>
                <input
                  type="date"
                  value={card.dueDate || ''}
                  onChange={(e) => onUpdate({ ...card, dueDate: e.target.value })}
                  style={{ padding: '0.5rem', borderRadius: '4px', border: '1px solid #e2e8f0', fontSize: '0.95rem' }}
                />
              </div>

              {/* Assignees */}
              <div className="modal-section">
                <div className="modal-section-title"><User size={16} /> Assignees</div>
                <div className="assignees-list">
                  {(card.assignees || []).map(assignee => (
                    <span key={assignee} className="assignee">
                      {assignee} <X size={12} onClick={() => removeAssignee(assignee)} style={{ cursor: 'pointer' }} />
                    </span>
                  ))}
                </div>
                <div className="add-assignee" style={{ marginTop: '0.5rem' }}>
                  <select
                    onChange={(e) => {
                      if (e.target.value) {
                        addAssignee(e.target.value);
                        e.target.value = '';
                      }
                    }}
                    className="assignee-select"
                  >
                    <option value="">Select user...</option>
                    {boardUsers.map(user => (
                      <option key={user} value={user}>{user}</option>
                    ))}
                  </select>
                  <input
                    type="text"
                    placeholder="Or type name..."
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        addAssignee(e.target.value);
                        e.target.value = '';
                      }
                    }}
                    className="assignee-input"
                  />
                </div>
              </div>

              {/* Labels */}
              <div className="modal-section">
                <div className="modal-section-title"><Tag size={16} /> Labels</div>
                <div className="labels-grid">
                  {boardLabels.map(label => (
                    <button
                      key={label.id}
                      className={`label-btn ${(card.labels || []).includes(label.id) ? 'active' : ''}`}
                      style={{ backgroundColor: label.bg, color: label.color }}
                      onClick={() => toggleLabel(label.id)}
                    >
                      {label.name}
                    </button>
                  ))}
                </div>
              </div>

              {/* Tags */}
              <div className="modal-section">
                <div className="modal-section-title">Free-form Tags</div>
                {card.tags && card.tags.length > 0 && (
                  <div className="card-tags" style={{ marginBottom: '0.5rem' }}>
                    {card.tags.map(tag => (
                      <span key={tag} className="tag">
                        {tag} <X size={12} onClick={() => removeTag(tag)} style={{ cursor: 'pointer' }} />
                      </span>
                    ))}
                  </div>
                )}
                <input
                  type="text"
                  placeholder="Add tag and press Enter..."
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      addTag(e.target.value);
                      e.target.value = '';
                    }
                  }}
                  style={{ width: '100%', padding: '0.5rem', borderRadius: '4px', border: '1px solid #e2e8f0' }}
                />
              </div>

              {/* Checklist */}
              <div className="modal-section">
                <div className="modal-section-title"><CheckSquare size={16} /> Checklist</div>
                {card.checklist && card.checklist.length > 0 && (
                  <div style={{ marginBottom: '0.5rem', fontSize: '0.85rem', color: '#64748b' }}>
                    {card.checklist.filter(i => i.done).length} of {card.checklist.length} completed
                  </div>
                )}
                <div className="checklist">
                  {(card.checklist || []).map(item => (
                    <div key={item.id} className="checklist-item">
                      <input
                        type="checkbox"
                        checked={item.done}
                        onChange={(e) => updateChecklistItem(item.id, { done: e.target.checked })}
                      />
                      <input
                        type="text"
                        value={item.text}
                        onChange={(e) => updateChecklistItem(item.id, { text: e.target.value })}
                        placeholder="Item text..."
                      />
                      <button onClick={() => deleteChecklistItem(item.id)} className="btn-icon">
                        <X size={14} />
                      </button>
                    </div>
                  ))}
                </div>
                <button onClick={addChecklistItem} className="btn-secondary">
                  <Plus size={14} /> Add Item
                </button>
              </div>

              {/* Custom Fields */}
              <div className="modal-section">
                <div className="modal-section-title">Custom Fields</div>
                {(card.customFields || []).map(field => (
                  <div key={field.id} className="custom-field">
                    <input
                      type="text"
                      value={field.name}
                      onChange={(e) => updateCustomField(field.id, { name: e.target.value })}
                      placeholder="Field name..."
                      className="field-name"
                    />
                    <select
                      value={field.type}
                      onChange={(e) => updateCustomField(field.id, { type: e.target.value, value: '' })}
                      className="field-type"
                    >
                      <option value="text">Text</option>
                      <option value="number">Number</option>
                      <option value="date">Date</option>
                      <option value="dropdown">Dropdown</option>
                      <option value="checkbox">Checkbox</option>
                    </select>
                    {field.type === 'text' && (
                      <input
                        type="text"
                        value={field.value}
                        onChange={(e) => updateCustomField(field.id, { value: e.target.value })}
                        placeholder="Value..."
                      />
                    )}
                    {field.type === 'number' && (
                      <input
                        type="number"
                        value={field.value}
                        onChange={(e) => updateCustomField(field.id, { value: e.target.value })}
                      />
                    )}
                    {field.type === 'date' && (
                      <input
                        type="date"
                        value={field.value}
                        onChange={(e) => updateCustomField(field.id, { value: e.target.value })}
                      />
                    )}
                    {field.type === 'checkbox' && (
                      <input
                        type="checkbox"
                        checked={field.value === 'true'}
                        onChange={(e) => updateCustomField(field.id, { value: e.target.checked.toString() })}
                      />
                    )}
                    {field.type === 'dropdown' && (
                      <input
                        type="text"
                        value={field.value}
                        onChange={(e) => updateCustomField(field.id, { value: e.target.value })}
                        placeholder="Options (comma separated) or value..."
                      />
                    )}
                    <button onClick={() => deleteCustomField(field.id)} className="btn-icon">
                      <X size={14} />
                    </button>
                  </div>
                ))}
                <button onClick={addCustomField} className="btn-secondary">
                  <Plus size={14} /> Add Field
                </button>
              </div>

              {/* Attachments */}
              <div className="modal-section">
                <div className="modal-section-title"><Paperclip size={16} /> Attachments</div>
                {card.attachments && card.attachments.length > 0 && (
                  <div className="attachments-list" style={{ marginBottom: '0.75rem' }}>
                    {card.attachments.map(attachment => (
                      <div 
                        key={attachment.id} 
                        className="attachment-item"
                        onClick={(e) => openAttachment(attachment, e)}
                        title="Click to open"
                      >
                        <div className="attachment-icon">
                          <Paperclip size={20} />
                        </div>
                        <div className="attachment-info">
                          <div className="attachment-name">{attachment.name}</div>
                          <div className="attachment-meta">
                            {formatFileSize(attachment.size)} • Added {new Date(attachment.uploadedAt).toLocaleDateString()}
                          </div>
                        </div>
                        <div className="attachment-actions">
                          <button 
                            onClick={(e) => { e.stopPropagation(); downloadAttachment(attachment); }} 
                            className="btn-icon" 
                            title="Download"
                          >
                            <Download size={16} />
                          </button>
                          <button 
                            onClick={(e) => { e.stopPropagation(); deleteAttachment(attachment.id); }} 
                            className="btn-icon" 
                            title="Delete"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                <label className="file-input-label">
                  <Paperclip size={16} /> Add Attachment
                  <input
                    type="file"
                    multiple
                    onChange={handleFileUpload}
                    className="file-input-hidden"
                  />
                </label>
              </div>

              {/* Activity and Comments */}
              <div className="modal-section">
                <div className="modal-section-title"><MessageSquare size={16} /> Activity & Comments</div>
                
                {/* Add new comment with formatting */}
                <div style={{ marginBottom: '1rem' }}>
                  {editingField === 'newComment' ? (
                    <div>
                      <div className="format-toolbar">
                        <button 
                          className="format-btn" 
                          onMouseDown={(e) => e.preventDefault()} 
                          onClick={() => applyFormat('bold')} 
                          title="Bold (**text**)"
                          type="button"
                        >
                          <Bold size={16} />
                        </button>
                        <button 
                          className="format-btn" 
                          onMouseDown={(e) => e.preventDefault()} 
                          onClick={() => applyFormat('italic')} 
                          title="Italic (*text*)"
                          type="button"
                        >
                          <Italic size={16} />
                        </button>
                        <button 
                          className="format-btn" 
                          onMouseDown={(e) => e.preventDefault()} 
                          onClick={() => applyFormat('underline')} 
                          title="Underline (__text__)"
                          type="button"
                        >
                          <Underline size={16} />
                        </button>
                        <button 
                          className="format-btn" 
                          onMouseDown={(e) => e.preventDefault()} 
                          onClick={() => applyFormat('bullet')} 
                          title="Bullet List (• )"
                          type="button"
                        >
                          <ListIcon size={16} />
                        </button>
                      </div>
                      <textarea
                        ref={textareaRef}
                        value={editValue}
                        onChange={(e) => setEditValue(e.target.value)}
                        placeholder="Write a comment..."
                        rows={4}
                        className="format-textarea"
                        style={{ width: '100%', padding: '0.75rem', border: '1px solid #e2e8f0', fontSize: '0.95rem' }}
                      />
                      <div style={{ marginTop: '0.5rem', display: 'flex', gap: '0.5rem' }}>
                        <button 
                          onClick={() => {
                            if (editValue.trim()) {
                              addComment(editValue);
                              setEditValue('');
                              setEditingField(null);
                            }
                          }} 
                          className="btn-primary"
                        >
                          Save
                        </button>
                        <button onClick={() => { setEditValue(''); setEditingField(null); }} className="btn-secondary">
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <div 
                      onClick={() => { setEditingField('newComment'); setEditValue(''); }}
                      style={{ 
                        padding: '0.75rem', 
                        background: '#f8fafc', 
                        border: '1px solid #e2e8f0', 
                        borderRadius: '4px', 
                        cursor: 'pointer',
                        color: '#64748b'
                      }}
                    >
                      Write a comment...
                    </div>
                  )}
                </div>

                {/* Comments list */}
                <div className="comments">
                  {(card.comments || []).map((comment, index) => (
                    <div key={comment.id} className="comment">
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '0.5rem' }}>
                        <div>
                          <strong>{comment.author}</strong>
                          <span className="comment-time"> {new Date(comment.timestamp).toLocaleString()}</span>
                        </div>
                        <div style={{ display: 'flex', gap: '0.25rem' }}>
                          <button 
                            onClick={() => { 
                              setEditingField(`comment-${comment.id}`); 
                              setEditValue(comment.text); 
                            }} 
                            className="btn-icon"
                            title="Edit"
                          >
                            <Edit2 size={14} />
                          </button>
                          <button 
                            onClick={() => {
                              if (confirm('Delete this comment?')) {
                                const comments = card.comments.filter(c => c.id !== comment.id);
                                onUpdate({ ...card, comments });
                              }
                            }} 
                            className="btn-icon"
                            title="Delete"
                          >
                            <X size={14} />
                          </button>
                        </div>
                      </div>
                      
                      {editingField === `comment-${comment.id}` ? (
                        <div>
                          <div className="format-toolbar">
                            <button 
                              className="format-btn" 
                              onMouseDown={(e) => e.preventDefault()} 
                              onClick={() => applyFormat('bold')} 
                              title="Bold (**text**)"
                              type="button"
                            >
                              <Bold size={16} />
                            </button>
                            <button 
                              className="format-btn" 
                              onMouseDown={(e) => e.preventDefault()} 
                              onClick={() => applyFormat('italic')} 
                              title="Italic (*text*)"
                              type="button"
                            >
                              <Italic size={16} />
                            </button>
                            <button 
                              className="format-btn" 
                              onMouseDown={(e) => e.preventDefault()} 
                              onClick={() => applyFormat('underline')} 
                              title="Underline (__text__)"
                              type="button"
                            >
                              <Underline size={16} />
                            </button>
                            <button 
                              className="format-btn" 
                              onMouseDown={(e) => e.preventDefault()} 
                              onClick={() => applyFormat('bullet')} 
                              title="Bullet List (• )"
                              type="button"
                            >
                              <ListIcon size={16} />
                            </button>
                          </div>
                          <textarea
                            ref={textareaRef}
                            value={editValue}
                            onChange={(e) => setEditValue(e.target.value)}
                            rows={4}
                            className="format-textarea"
                            style={{ width: '100%', padding: '0.75rem', border: '1px solid #e2e8f0', fontSize: '0.95rem' }}
                          />
                          <div style={{ marginTop: '0.5rem', display: 'flex', gap: '0.5rem' }}>
                            <button 
                              onClick={() => {
                                const comments = card.comments.map(c => 
                                  c.id === comment.id ? { ...c, text: editValue, edited: true } : c
                                );
                                onUpdate({ ...card, comments });
                                setEditingField(null);
                              }} 
                              className="btn-primary"
                            >
                              Save
                            </button>
                            <button onClick={() => setEditingField(null)} className="btn-secondary">
                              Cancel
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div style={{ color: '#1e293b' }}>
                          {renderFormattedDescription(comment.text)}
                          {comment.edited && (
                            <span style={{ fontSize: '0.75rem', color: '#94a3b8', fontStyle: 'italic', marginLeft: '0.5rem' }}>
                              (edited)
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {/* Card Color */}
              <div className="modal-section">
                <div className="modal-section-title"><Palette size={16} /> Card Color</div>
                <div className="color-grid">
                  {['#ffffff', '#fee2e2', '#ffedd5', '#fef9c3', '#dcfce7', '#dbeafe', '#f3e8ff', '#fce7f3'].map(color => (
                    <button
                      key={color}
                      className={`color-btn ${card.color === color ? 'active' : ''}`}
                      style={{ backgroundColor: color }}
                      onClick={() => onUpdate({ ...card, color })}
                    />
                  ))}
                </div>
              </div>

              {/* Cover Image */}
              {!card.coverImage && (
                <div className="modal-section">
                  <div className="modal-section-title"><Image size={16} /> Cover Image</div>
                  <label className="file-input-label">
                    <Image size={16} /> Add Cover Image
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handleCoverUpload}
                      className="file-input-hidden"
                    />
                  </label>
                </div>
              )}
            </div>

            <div className="modal-footer">
              <button onClick={() => { onSaveAsTemplate(card); onClose(); }} className="btn-secondary">
                <Copy size={14} /> Save as Template
              </button>
              <button onClick={() => { onArchive(card.id); onClose(); }} className="btn-secondary">
                <Archive size={14} /> Archive
              </button>
              <button onClick={() => { if (confirm('Delete this card?')) { onDelete(card.id); onClose(); } }} className="btn-danger">
                <Trash2 size={14} /> Delete
              </button>
            </div>
          </div>
        </div>
      );
    };

    // List component
    const List = ({ list, cards, onUpdateList, onDeleteList, onAddCard, onUpdateCard, onDeleteCard, onArchiveCard, boardLabels, boardUsers, onSaveAsTemplate, onOpenModal }) => {
      const [isAddingCard, setIsAddingCard] = useState(false);
      const [newCardTitle, setNewCardTitle] = useState('');
      const [isEditingTitle, setIsEditingTitle] = useState(false);
      const [editTitle, setEditTitle] = useState(list.title);

      const handleAddCard = () => {
        if (newCardTitle.trim()) {
          onAddCard(list.id, newCardTitle);
          setNewCardTitle('');
          setIsAddingCard(false);
        }
      };

      const handleSaveTitle = () => {
        if (editTitle.trim()) {
          onUpdateList({ ...list, title: editTitle });
        }
        setIsEditingTitle(false);
      };

      const handleDrop = (e) => {
        e.preventDefault();
        const cardId = e.dataTransfer.getData('cardId');
        if (cardId) {
          const card = cards.find(c => c.id === cardId);
          if (card && card.listId !== list.id) {
            onUpdateCard({ ...card, listId: list.id });
          }
        }
      };

      return (
        <div
          className="list"
          onDragOver={(e) => e.preventDefault()}
          onDrop={handleDrop}
        >
          <div className="list-header">
            {isEditingTitle ? (
              <input
                value={editTitle}
                onChange={(e) => setEditTitle(e.target.value)}
                onBlur={handleSaveTitle}
                onKeyPress={(e) => e.key === 'Enter' && handleSaveTitle()}
                autoFocus
                className="list-title-input"
              />
            ) : (
              <h3 onClick={() => setIsEditingTitle(true)} className="list-title">
                {list.title} <span className="card-count">({cards.length})</span>
              </h3>
            )}
            <button onClick={() => onDeleteList(list.id)} className="btn-icon">
              <Trash2 size={16} />
            </button>
          </div>

          <div className="cards">
            {cards.map(card => (
              <Card
                key={card.id}
                card={card}
                onUpdate={onUpdateCard}
                onDelete={onDeleteCard}
                onArchive={onArchiveCard}
                boardLabels={boardLabels}
                boardUsers={boardUsers}
                onSaveAsTemplate={onSaveAsTemplate}
                onOpenModal={onOpenModal}
              />
            ))}
          </div>

          {isAddingCard ? (
            <div className="add-card-form">
              <input
                value={newCardTitle}
                onChange={(e) => setNewCardTitle(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleAddCard()}
                placeholder="Enter card title..."
                autoFocus
              />
              <div className="form-actions">
                <button onClick={handleAddCard} className="btn-primary">Add</button>
                <button onClick={() => setIsAddingCard(false)} className="btn-secondary">Cancel</button>
              </div>
            </div>
          ) : (
            <button onClick={() => setIsAddingCard(true)} className="btn-add-card">
              <Plus size={16} /> Add Card
            </button>
          )}
        </div>
      );
    };

    // Calendar View component
    const CalendarView = ({ cards, lists, onClose, onUpdateCard, currentBoard }) => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(null);
      const [appointments, setAppointments] = useState([]);
      const [showEventForm, setShowEventForm] = useState(false);
      const [newEvent, setNewEvent] = useState({ title: '', date: '', time: '', description: '', type: 'appointment' });

      useEffect(() => {
        const savedAppointments = storage.get(`appointments_${currentBoard?.id}`);
        if (savedAppointments) setAppointments(savedAppointments);
      }, [currentBoard]);

      useEffect(() => {
        if (currentBoard) {
          storage.set(`appointments_${currentBoard.id}`, appointments);
        }
      }, [appointments, currentBoard]);

      const daysInMonth = (date) => {
        return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
      };

      const firstDayOfMonth = (date) => {
        return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
      };

      const getDaysArray = () => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = firstDayOfMonth(currentDate);
        const daysInCurrentMonth = daysInMonth(currentDate);
        const daysInPrevMonth = daysInMonth(new Date(year, month - 1));

        let days = [];

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
          days.push({
            day: daysInPrevMonth - i,
            month: month - 1,
            year: month === 0 ? year - 1 : year,
            isOtherMonth: true
          });
        }

        // Current month days
        for (let i = 1; i <= daysInCurrentMonth; i++) {
          days.push({
            day: i,
            month: month,
            year: year,
            isOtherMonth: false
          });
        }

        // Next month days
        const remainingDays = 42 - days.length;
        for (let i = 1; i <= remainingDays; i++) {
          days.push({
            day: i,
            month: month + 1,
            year: month === 11 ? year + 1 : year,
            isOtherMonth: true
          });
        }

        return days;
      };

      const isToday = (day) => {
        const today = new Date();
        return day.day === today.getDate() && 
               day.month === today.getMonth() && 
               day.year === today.getFullYear();
      };

      const getEventsForDay = (day) => {
        const dateStr = `${day.year}-${String(day.month + 1).padStart(2, '0')}-${String(day.day).padStart(2, '0')}`;
        
        const cardDues = cards.filter(card => {
          if (!card.dueDate) return false;
          const cardDate = card.dueDate.split('T')[0];
          return cardDate === dateStr;
        }).map(card => ({
          type: 'card',
          title: card.title,
          card: card
        }));

        const appts = appointments.filter(appt => {
          const apptDate = appt.date.split('T')[0];
          return apptDate === dateStr;
        }).map(appt => ({
          type: 'appointment',
          title: appt.title,
          appointment: appt
        }));

        return [...cardDues, ...appts];
      };

      const addAppointment = () => {
        if (!newEvent.title || !newEvent.date) return;
        
        const appointment = {
          id: Date.now().toString(),
          ...newEvent,
          createdAt: new Date().toISOString()
        };

        setAppointments([...appointments, appointment]);
        setNewEvent({ title: '', date: '', time: '', description: '', type: 'appointment' });
        setShowEventForm(false);
      };

      const deleteAppointment = (id) => {
        if (confirm('Delete this appointment?')) {
          setAppointments(appointments.filter(a => a.id !== id));
        }
      };

      const prevMonth = () => {
        setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1));
      };

      const nextMonth = () => {
        setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1));
      };

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      const days = getDaysArray();

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '1200px' }}>
            <div className="modal-header">
              <h2 className="modal-title">Calendar</h2>
              <button onClick={onClose} className="modal-close">
                <X size={24} />
              </button>
            </div>

            <div className="modal-body">
              <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '1.5rem' }}>
                {/* Calendar */}
                <div className="calendar-view">
                  <div className="calendar-header">
                    <h3 className="calendar-title">
                      {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
                    </h3>
                    <div className="calendar-nav">
                      <button onClick={prevMonth} className="btn-secondary">
                        <ChevronLeft size={16} />
                      </button>
                      <button onClick={() => setCurrentDate(new Date())} className="btn-secondary">
                        Today
                      </button>
                      <button onClick={nextMonth} className="btn-secondary">
                        <ChevronRight size={16} />
                      </button>
                    </div>
                  </div>

                  <div className="calendar-grid">
                    {dayNames.map(day => (
                      <div key={day} className="calendar-day-header">{day}</div>
                    ))}
                    
                    {days.map((day, index) => {
                      const events = getEventsForDay(day);
                      const isTodayDay = isToday(day);

                      return (
                        <div
                          key={index}
                          className={`calendar-day ${day.isOtherMonth ? 'other-month' : ''} ${isTodayDay ? 'today' : ''}`}
                          onClick={() => {
                            setSelectedDate(day);
                            setNewEvent({ ...newEvent, date: `${day.year}-${String(day.month + 1).padStart(2, '0')}-${String(day.day).padStart(2, '0')}` });
                            setShowEventForm(true);
                          }}
                        >
                          <div className="calendar-day-number">{day.day}</div>
                          <div className="calendar-events">
                            {events.map((event, i) => (
                              <div
                                key={i}
                                className={`calendar-event ${event.type === 'card' ? 'card-due' : 'appointment'}`}
                                onClick={(e) => {
                                  e.stopPropagation();
                                  if (event.type === 'card') {
                                    // Could open the card modal here
                                  }
                                }}
                                title={event.title}
                              >
                                {event.title}
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Sidebar */}
                <div className="calendar-sidebar">
                  <h4 style={{ marginBottom: '1rem', fontWeight: 600 }}>
                    {showEventForm ? 'New Appointment' : 'Upcoming Events'}
                  </h4>

                  {showEventForm ? (
                    <div className="event-form">
                      <input
                        type="text"
                        placeholder="Event title"
                        value={newEvent.title}
                        onChange={(e) => setNewEvent({ ...newEvent, title: e.target.value })}
                      />
                      <input
                        type="date"
                        value={newEvent.date}
                        onChange={(e) => setNewEvent({ ...newEvent, date: e.target.value })}
                      />
                      <input
                        type="time"
                        value={newEvent.time}
                        onChange={(e) => setNewEvent({ ...newEvent, time: e.target.value })}
                      />
                      <textarea
                        placeholder="Description (optional)"
                        value={newEvent.description}
                        onChange={(e) => setNewEvent({ ...newEvent, description: e.target.value })}
                        rows={3}
                      />
                      <div style={{ display: 'flex', gap: '0.5rem' }}>
                        <button onClick={addAppointment} className="btn-primary">
                          Add Appointment
                        </button>
                        <button onClick={() => setShowEventForm(false)} className="btn-secondary">
                          Cancel
                        </button>
                      </div>
                    </div>
                  ) : (
                    <>
                      <button 
                        onClick={() => {
                          setNewEvent({ title: '', date: '', time: '', description: '', type: 'appointment' });
                          setShowEventForm(true);
                        }} 
                        className="btn-primary"
                        style={{ width: '100%', marginBottom: '1rem' }}
                      >
                        <Plus size={16} /> New Appointment
                      </button>

                      <div className="event-list">
                        {appointments
                          .sort((a, b) => new Date(a.date) - new Date(b.date))
                          .slice(0, 10)
                          .map(appt => (
                            <div key={appt.id} className="event-item">
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                <div style={{ flex: 1 }}>
                                  <div className="event-item-title">{appt.title}</div>
                                  <div className="event-item-meta">
                                    {new Date(appt.date).toLocaleDateString()}
                                    {appt.time && ` at ${appt.time}`}
                                  </div>
                                  {appt.description && (
                                    <div style={{ fontSize: '0.85rem', marginTop: '0.25rem', color: '#64748b' }}>
                                      {appt.description}
                                    </div>
                                  )}
                                </div>
                                <button onClick={() => deleteAppointment(appt.id)} className="btn-icon">
                                  <X size={14} />
                                </button>
                              </div>
                            </div>
                          ))}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Main App component
    const TrelloApp = () => {
      const [boards, setBoards] = useState([]);
      const [currentBoardId, setCurrentBoardId] = useState(null);
      const [lists, setLists] = useState([]);
      const [cards, setCards] = useState([]);
      const [templates, setTemplates] = useState([]);
      const [isAddingBoard, setIsAddingBoard] = useState(false);
      const [isAddingList, setIsAddingList] = useState(false);
      const [newBoardTitle, setNewBoardTitle] = useState('');
      const [newListTitle, setNewListTitle] = useState('');
      const [showSettings, setShowSettings] = useState(false);
      const [showTemplates, setShowTemplates] = useState(false);
      const [loading, setLoading] = useState(true);
      const [quickTheme, setQuickTheme] = useState('light');
      const [selectedCard, setSelectedCard] = useState(null);
      const [showCalendar, setShowCalendar] = useState(false);

      const currentBoard = boards.find(b => b.id === currentBoardId);

      const openCardModal = (card) => {
        setSelectedCard(card);
      };

      const closeCardModal = () => {
        setSelectedCard(null);
      };

      useEffect(() => {
        loadData();
        const savedTheme = localStorage.getItem('grasshopper_quick_theme');
        if (savedTheme) {
          setQuickTheme(savedTheme);
        }
      }, []);

      const loadData = () => {
        const boardsData = storage.get('boards');
        const listsData = storage.get('lists');
        const cardsData = storage.get('cards');
        const templatesData = storage.get('templates');

        if (boardsData) setBoards(boardsData);
        if (listsData) setLists(listsData);
        if (cardsData) setCards(cardsData);
        if (templatesData) setTemplates(templatesData);

        if (boardsData && boardsData.length > 0 && !currentBoardId) {
          setCurrentBoardId(boardsData[0].id);
        }

        setLoading(false);
      };

      useEffect(() => {
        if (!loading) {
          storage.set('boards', boards);
        }
      }, [boards, loading]);

      useEffect(() => {
        if (!loading) {
          storage.set('lists', lists);
        }
      }, [lists, loading]);

      useEffect(() => {
        if (!loading) {
          storage.set('cards', cards);
        }
      }, [cards, loading]);

      useEffect(() => {
        if (!loading) {
          storage.set('templates', templates);
        }
      }, [templates, loading]);

      const addBoard = () => {
        if (newBoardTitle.trim()) {
          const newBoard = {
            id: Date.now().toString(),
            title: newBoardTitle,
            background: BOARD_BACKGROUNDS[0].color,
            theme: 'light',
            labels: LABEL_COLORS.map((c, i) => ({ id: `label-${i}`, ...c })),
            users: []
          };
          setBoards([...boards, newBoard]);
          setCurrentBoardId(newBoard.id);
          setNewBoardTitle('');
          setIsAddingBoard(false);
        }
      };

      const updateBoard = (updatedBoard) => {
        setBoards(boards.map(b => b.id === updatedBoard.id ? updatedBoard : b));
      };

      const deleteBoard = (boardId) => {
        if (confirm('Delete this board and all its lists and cards?')) {
          setBoards(boards.filter(b => b.id !== boardId));
          setLists(lists.filter(l => l.boardId !== boardId));
          setCards(cards.filter(c => {
            const list = lists.find(l => l.id === c.listId);
            return !list || list.boardId !== boardId;
          }));
          if (currentBoardId === boardId) {
            setCurrentBoardId(boards[0]?.id || null);
          }
        }
      };

      const addList = () => {
        if (newListTitle.trim() && currentBoardId) {
          const newList = {
            id: Date.now().toString(),
            boardId: currentBoardId,
            title: newListTitle,
            order: lists.filter(l => l.boardId === currentBoardId).length
          };
          setLists([...lists, newList]);
          setNewListTitle('');
          setIsAddingList(false);
        }
      };

      const updateList = (updatedList) => {
        setLists(lists.map(l => l.id === updatedList.id ? updatedList : l));
      };

      const deleteList = (listId) => {
        if (confirm('Delete this list and all its cards?')) {
          setLists(lists.filter(l => l.id !== listId));
          setCards(cards.filter(c => c.listId !== listId));
        }
      };

      const addCard = (listId, title) => {
        const newCard = {
          id: Date.now().toString(),
          listId,
          title,
          description: '',
          dueDate: '',
          labels: [],
          tags: [],
          assignees: [],
          checklist: [],
          comments: [],
          customFields: [],
          color: '#ffffff',
          archived: false
        };
        setCards([...cards, newCard]);
      };

      const addCardFromTemplate = (listId, template) => {
        const newCard = {
          ...template,
          id: Date.now().toString(),
          listId,
          comments: [],
          archived: false
        };
        setCards([...cards, newCard]);
      };

      const updateCard = (updatedCard) => {
        setCards(cards.map(c => c.id === updatedCard.id ? updatedCard : c));
      };

      const deleteCard = (cardId) => {
        if (confirm('Delete this card?')) {
          setCards(cards.filter(c => c.id !== cardId));
        }
      };

      const archiveCard = (cardId) => {
        setCards(cards.map(c => c.id === cardId ? { ...c, archived: true } : c));
      };

      const saveAsTemplate = (card) => {
        const template = {
          ...card,
          id: Date.now().toString(),
          name: `${card.title} Template`
        };
        setTemplates([...templates, template]);
        alert('Card saved as template!');
      };

      const deleteTemplate = (templateId) => {
        setTemplates(templates.filter(t => t.id !== templateId));
      };

      const addUser = (userName) => {
        if (!userName.trim() || !currentBoard) return;
        const users = [...(currentBoard.users || []), userName.trim()];
        updateBoard({ ...currentBoard, users });
      };

      const removeUser = (userName) => {
        if (!currentBoard) return;
        const users = currentBoard.users.filter(u => u !== userName);
        updateBoard({ ...currentBoard, users });
      };

      const toggleQuickTheme = () => {
        const newTheme = quickTheme === 'light' ? 'dark' : 'light';
        setQuickTheme(newTheme);
        localStorage.setItem('grasshopper_quick_theme', newTheme);
      };

      const backupData = () => {
        const backup = {
          boards,
          lists,
          cards,
          templates,
          timestamp: new Date().toISOString(),
          appVersion: '1.0'
        };

        const dataStr = JSON.stringify(backup, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `grasshopper-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        alert('Backup downloaded! Save this file to your Google Drive for safekeeping.');
      };

      const restoreData = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const backup = JSON.parse(event.target.result);
              
              if (!backup.boards || !backup.lists || !backup.cards) {
                alert('Invalid backup file format.');
                return;
              }

              if (confirm('This will replace all current data with the backup. Continue?')) {
                setBoards(backup.boards);
                setLists(backup.lists);
                setCards(backup.cards);
                setTemplates(backup.templates || []);
                
                if (backup.boards.length > 0) {
                  setCurrentBoardId(backup.boards[0].id);
                }

                alert('Data restored successfully!');
              }
            } catch (error) {
              alert('Error reading backup file. Please make sure it\'s a valid Grasshopper backup.');
              console.error('Restore error:', error);
            }
          };
          reader.readAsText(file);
        };
        input.click();
      };

      if (loading) {
        return <div className="loading">Loading...</div>;
      }

      const currentLists = lists.filter(l => l.boardId === currentBoardId).sort((a, b) => a.order - b.order);
      const activeCards = cards.filter(c => !c.archived);
      const archivedCards = cards.filter(c => c.archived);

      const theme = currentBoard ? THEMES[currentBoard.theme] : THEMES[quickTheme];

      return (
        <div className="app" style={{ background: currentBoard?.background || theme.bg, color: theme.text }}>
          <div className="header" style={{ backgroundColor: theme.cardBg, borderBottom: `1px solid ${theme.border}` }}>
            <div className="header-left">
              <h1>Grasshopper</h1>
              <select
                value={currentBoardId || ''}
                onChange={(e) => setCurrentBoardId(e.target.value)}
                className="board-select"
                style={{ backgroundColor: theme.cardBg, color: theme.text, borderColor: theme.border }}
              >
                <option value="">Select Board...</option>
                {boards.map(board => (
                  <option key={board.id} value={board.id}>{board.title}</option>
                ))}
              </select>
              {isAddingBoard ? (
                <div className="add-board-form">
                  <input
                    value={newBoardTitle}
                    onChange={(e) => setNewBoardTitle(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addBoard()}
                    placeholder="Board title..."
                    autoFocus
                    style={{ backgroundColor: theme.cardBg, color: theme.text, borderColor: theme.border }}
                  />
                  <button onClick={addBoard} className="btn-primary">Add</button>
                  <button onClick={() => setIsAddingBoard(false)} className="btn-secondary">Cancel</button>
                </div>
              ) : (
                <button onClick={() => setIsAddingBoard(true)} className="btn-primary">
                  <Plus size={16} /> New Board
                </button>
              )}
            </div>
            <div className="header-right">
              <button onClick={toggleQuickTheme} className="btn-icon" title={`Switch to ${quickTheme === 'light' ? 'dark' : 'light'} mode`}>
                {quickTheme === 'light' ? <Moon size={20} /> : <Sun size={20} />}
              </button>
              <button onClick={() => setShowCalendar(true)} className="btn-secondary">
                <Calendar size={16} /> Calendar
              </button>
              <button onClick={backupData} className="btn-secondary">
                <Copy size={16} /> Backup Data
              </button>
              <button onClick={restoreData} className="btn-secondary">
                <Settings size={16} /> Restore Data
              </button>
              <button onClick={() => setShowTemplates(!showTemplates)} className="btn-secondary">
                <Copy size={16} /> Templates ({templates.length})
              </button>
              <button onClick={() => setShowSettings(!showSettings)} className="btn-secondary">
                <Settings size={16} /> Settings
              </button>
            </div>
          </div>

          {showSettings && currentBoard && (
            <div className="settings-panel" style={{ backgroundColor: theme.cardBg, borderBottom: `1px solid ${theme.border}` }}>
              <h3>Board Settings</h3>
              
              <div className="settings-section">
                <label>Board Name</label>
                <input
                  value={currentBoard.title}
                  onChange={(e) => updateBoard({ ...currentBoard, title: e.target.value })}
                  style={{ backgroundColor: theme.cardBg, color: theme.text, borderColor: theme.border }}
                />
              </div>

              <div className="settings-section">
                <label>Background</label>
                <div className="backgrounds-grid">
                  {BOARD_BACKGROUNDS.map(bg => (
                    <button
                      key={bg.name}
                      className={`bg-btn ${currentBoard.background === bg.color ? 'active' : ''}`}
                      style={{ background: bg.color }}
                      onClick={() => updateBoard({ ...currentBoard, background: bg.color })}
                      title={bg.name}
                    />
                  ))}
                </div>
              </div>

              <div className="settings-section">
                <label>Theme</label>
                <div className="theme-buttons">
                  {Object.entries(THEMES).map(([key, t]) => (
                    <button
                      key={key}
                      className={`theme-btn ${currentBoard.theme === key ? 'active' : ''}`}
                      onClick={() => updateBoard({ ...currentBoard, theme: key })}
                    >
                      {t.name}
                    </button>
                  ))}
                </div>
              </div>

              <div className="settings-section">
                <label>Team Members</label>
                <div className="users-list">
                  {(currentBoard.users || []).map(user => (
                    <span key={user} className="user-badge">
                      {user} <X size={12} onClick={() => removeUser(user)} style={{ cursor: 'pointer' }} />
                    </span>
                  ))}
                </div>
                <input
                  type="text"
                  placeholder="Add team member and press Enter..."
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      addUser(e.target.value);
                      e.target.value = '';
                    }
                  }}
                  style={{ backgroundColor: theme.cardBg, color: theme.text, borderColor: theme.border }}
                />
              </div>

              <div className="settings-section">
                <label>Board Labels</label>
                <div className="labels-list">
                  {currentBoard.labels.map(label => (
                    <span key={label.id} className="label" style={{ backgroundColor: label.bg, color: label.color }}>
                      {label.name}
                    </span>
                  ))}
                </div>
              </div>

              <button onClick={() => deleteBoard(currentBoard.id)} className="btn-danger">
                <Trash2 size={14} /> Delete Board
              </button>
            </div>
          )}

          {showTemplates && (
            <div className="templates-panel" style={{ backgroundColor: theme.cardBg, borderBottom: `1px solid ${theme.border}` }}>
              <h3>Card Templates</h3>
              {templates.length === 0 ? (
                <p>No templates yet. Save a card as a template to get started!</p>
              ) : (
                <div className="templates-grid">
                  {templates.map(template => (
                    <div key={template.id} className="template-card" style={{ backgroundColor: template.color }}>
                      <h4>{template.name}</h4>
                      <p>{template.description}</p>
                      <div className="template-actions">
                        <button
                          onClick={() => {
                            if (currentLists.length > 0) {
                              addCardFromTemplate(currentLists[0].id, template);
                              setShowTemplates(false);
                            }
                          }}
                          className="btn-primary"
                          disabled={currentLists.length === 0}
                        >
                          Use Template
                        </button>
                        <button onClick={() => deleteTemplate(template.id)} className="btn-danger">
                          <Trash2 size={14} />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {!currentBoardId ? (
            <div className="empty-state">
              <h2>Welcome to Grasshopper!</h2>
              <p>Create your first board to get started.</p>
            </div>
          ) : (
            <div className="board">
              <div className="lists-container">
                {currentLists.map(list => (
                  <List
                    key={list.id}
                    list={list}
                    cards={activeCards.filter(c => c.listId === list.id)}
                    onUpdateList={updateList}
                    onDeleteList={deleteList}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                    onDeleteCard={deleteCard}
                    onArchiveCard={archiveCard}
                    boardLabels={currentBoard?.labels || []}
                    boardUsers={currentBoard?.users || []}
                    onSaveAsTemplate={saveAsTemplate}
                    onOpenModal={openCardModal}
                  />
                ))}

                {isAddingList ? (
                  <div className="add-list-form">
                    <input
                      value={newListTitle}
                      onChange={(e) => setNewListTitle(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addList()}
                      placeholder="List title..."
                      autoFocus
                      style={{ backgroundColor: theme.cardBg, color: theme.text, borderColor: theme.border }}
                    />
                    <div className="form-actions">
                      <button onClick={addList} className="btn-primary">Add</button>
                      <button onClick={() => setIsAddingList(false)} className="btn-secondary">Cancel</button>
                    </div>
                  </div>
                ) : (
                  <button onClick={() => setIsAddingList(true)} className="btn-add-list">
                    <Plus size={18} /> Add List
                  </button>
                )}
              </div>

              {archivedCards.length > 0 && (
                <div className="archived-section" style={{ backgroundColor: theme.cardBg, borderTop: `1px solid ${theme.border}` }}>
                  <h3><Archive size={18} /> Archived Cards ({archivedCards.length})</h3>
                  <div className="archived-cards">
                    {archivedCards.map(card => {
                      const list = lists.find(l => l.id === card.listId);
                      return (
                        <div key={card.id} className="archived-card">
                          <span>{card.title} <small>(from {list?.title})</small></span>
                          <div>
                            <button onClick={() => updateCard({ ...card, archived: false })} className="btn-secondary">
                              Restore
                            </button>
                            <button onClick={() => deleteCard(card.id)} className="btn-danger">
                              <Trash2 size={14} />
                            </button>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          )}

          {selectedCard && (
            <CardModal
              card={selectedCard}
              onClose={closeCardModal}
              onUpdate={updateCard}
              onDelete={deleteCard}
              onArchive={archiveCard}
              boardLabels={currentBoard?.labels || []}
              boardUsers={currentBoard?.users || []}
              onSaveAsTemplate={saveAsTemplate}
            />
          )}

          {showCalendar && (
            <CalendarView
              cards={activeCards}
              lists={lists}
              onClose={() => setShowCalendar(false)}
              onUpdateCard={updateCard}
              currentBoard={currentBoard}
            />
          )}
        </div>
      );
    };

    ReactDOM.render(<TrelloApp />, document.getElementById('root'));
  </script>
</body>
</html>